rule Detect_New_Malware_bedfffb7
{
    meta:
        description = "Detects text-log based malware sample bedfffb7 and neighbors using specific API and DLL indicators related to console and file manipulation."
        author = "malware-analyst"
        sha256 = "bedfffb784db4b18bf373195f4443f3fc10bf9f2f1eb5f2502dcc83a56919a48"
        created = "2023-10-27"

    strings:
        // Behavioral Indicators (APIs from new sample and neighbors)
        $api_impersonateanonymous = "impersonateanonymoustoken"
        $api_console_aliases_len = "getconsolealiaseslengtha"
        $api_setdefaultcommconfigw = "setdefaultcommconfigw"
        $api_enum_calendar = "enumcalendarinfoexa"
        $api_comm_timeouts = "getcommtimeouts"
        $api_openjobobjecta = "openjobobjecta"
        $api_getbinarytypew = "getbinarytypew"
        $api_getgeoinfow = "getgeoinfow"
        $api_getconsoleoutputcp = "getconsoleoutputcp"
        $api_setconsolemode = "setconsolemode"
        $api_getdiskfreespacew = "getdiskfreespacew"
        $api_getatomnamew = "getatomnamew"
        $api_movefileexa = "movefileexa"
        $api_getdateformatw = "getdateformatw" // Found in neighbor 2
        $api_getbinarytypew_alt = "getbinarytypea" // Found in neighbors
        $api_setcalendarinfoa = "setcalendarinfoa" // Found in neighbor 2
        $api_findnextvolumea = "findnextvolumea" // Found in neighbor 2
        
        // Imported DLLs
        $dll_advapi32 = "advapi32.dll"
        $dll_kernel32 = "kernel32.dll"

        // Benign Filter strings (to avoid) - Implicitly handled by selection of specific APIs above which are absent in benign context provided.
        // However, explicit exclusion of purely generic combos is good practice if rule matches broadly. 
        // Based on provided negative context, the above APIs are not present.

    condition:
        // Logic: 
        // 1. Must include specific DLLs found in target (advapi32, kernel32) AND strong unique API indicators.
        // 2. Must utilize a subset of the unique behavioral APIs found in the target/neighbors but NOT in benign files.
        
        $dll_advapi32 and $dll_kernel32 and
        (
            2 of ($api_impersonateanonymous, $api_console_aliases_len, $api_setdefaultcommconfigw, $api_enum_calendar) or
            4 of ($api_comm_timeouts, $api_openjobobjecta, $api_getbinarytypew, $api_getgeoinfow, $api_getconsoleoutputcp, $api_setconsolemode, $api_getdiskfreespacew, $api_getatomnamew, $api_movefileexa, $api_getdateformatw, $api_getbinarytypew_alt, $api_setcalendarinfoa, $api_findnextvolumea)
        )
}