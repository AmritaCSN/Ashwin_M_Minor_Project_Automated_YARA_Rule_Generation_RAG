rule Detect_New_Malware_12865d3c
{
    meta:
        description = "Detects text-log based malware sample 12865d3c and neighbors using specific API indicators related to console manipulation and resource updating."
        author = "malware-analyst"
        sha256 = "12865d3cf5f64bc049434b136eeeb9e0ebb53d6cd9d29945f082da45929d5fa7"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators (APIs from new sample and neighbors) */
        $api_beginupdateresource    = "beginupdateresourcew" nocase
        $api_enumresnames           = "enumresourcenamesw" nocase
        $api_console_aliases        = "getconsolealiaseslengtha" nocase
        $api_console_alias_exes     = "getconsolealiasexeslengthw" nocase
        $api_comm_timeouts          = "getcommtimeouts" nocase
        $api_buildcomm              = "buildcommdcbandtimeoutsw" nocase
        $api_numa                   = "getnumahighestnodenumber" nocase
        $api_firmware               = "getfirmwareenvironmentvariablew" nocase
        $api_write_console_char     = "writeconsoleoutputcharacterw" nocase
        $api_read_console_char      = "readconsoleoutputcharacterw" nocase
        $api_add_console_alias      = "addconsolealiasw" nocase
        $api_enum_calendar          = "enumcalendarinfoa" nocase
        $api_openeventlog           = "openeventloga" nocase
        $api_unregisterwait         = "unregisterwait" nocase

        /* Neighbor Shared/Unique API Indicators */
        $api_getconsolealiasexes    = "getconsolealiasexesw" nocase
        $api_lopen                  = "lopen" nocase
        $api_hread                  = "hread" nocase
        $api_lwrite                 = "lwrite" nocase
        $api_createmutexa           = "createmutexa" nocase

    condition:
        (
            $api_beginupdateresource and $api_enumresnames and
            2 of ($api_console_aliases, $api_console_alias_exes, $api_comm_timeouts, $api_buildcomm)
        )
        or
        (
            4 of ($api_numa, $api_firmware, $api_write_console_char, $api_read_console_char, $api_add_console_alias,
                  $api_enum_calendar, $api_openeventlog, $api_unregisterwait, $api_getconsolealiasexes,
                  $api_lopen, $api_hread, $api_lwrite, $api_createmutexa)
        )
}
