rule Detect_New_Malware_50977f98
{
    meta:
        description = "Detects text-log based malware sample 50977f98 and neighbors using specific API and DLL indicators related to GDI and shell interaction."
        author = "malware-analyst"
        sha256 = "50977f9814be39f4ebc45c3ae255f33c2ba0a25c7b626fdbd9225a2fa458f33c"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators (APIs from new sample and neighbors) */
        $api_gdipcloneimage             = "gdipcloneimage" nocase
        $api_gdipaddpathlinei           = "gdipaddpathlinei" nocase
        $api_alphablend                 = "alphablend" nocase
        $api_transparentblt             = "transparentblt" nocase
        $api_realshellexecuteexw        = "realshellexecuteexw" nocase
        $api_shgetdiskfreespaceexa      = "shgetdiskfreespaceexa" nocase
        $api_pifmgrcloseproperties      = "pifmgrcloseproperties" nocase
        $api_dllinstall                 = "dllinstall" nocase
        $api_shregcloseuskey            = "shregcloseuskey" nocase
        $api_urlunescapea               = "urlunescapea" nocase
        $api_pathsearchandqualifya      = "pathsearchandqualifya" nocase
        $api_symfindfileinpath          = "symfindfileinpath" nocase
        $api_symenumeratesymbols        = "symenumeratesymbols" nocase
        $api_coreactivateobject         = "coreactivateobject" nocase
        $api_stgmediumusermarshal       = "stgmediumusermarshal" nocase
        $api_registermessagepumphook    = "registermessagepumphook" nocase
        $api_mcigetdeviceidfromelementidw = "mcigetdeviceidfromelementidw" nocase
        $api_waveoutpause               = "waveoutpause" nocase
        $api_mmiosetinfo                = "mmiosetinfo" nocase
        $api_waveoutwrite               = "waveoutwrite" nocase
        $api_vardatefromdisp            = "vardatefromdisp" nocase
        $api_vardecfromi4               = "vardecfromi4" nocase
        $api_oleuiaddverbmenua          = "oleuiaddverbmenua" nocase
        $api_oleuiobjectpropertiesa     = "oleuiobjectpropertiesa" nocase
        $api_oleuiinsertobjectw         = "oleuiinsertobjectw" nocase
        $api_oleuipromptuserw           = "oleuipromptuserw" nocase
        $api_printersgetcommandrundll   = "printersgetcommandrundll" nocase
        $api_controltracew              = "controltracew" nocase
        $api_queryservicestatusex       = "queryservicestatusex" nocase
        $api_deregistereventsource      = "deregistereventsource" nocase
        $api_pathappendw                = "pathappendw" nocase

        /* Imported DLLs */
        $dll_gdiplus   = "gdiplus.dll" nocase
        $dll_winspool  = "winspool.drv" nocase
        $dll_msimg32   = "msimg32.dll" nocase
        $dll_imagehlp  = "imagehlp.dll" nocase
        $dll_oledlg    = "oledlg.dll" nocase
        $dll_oleacc    = "oleacc.dll" nocase
        $dll_winmm     = "winmm.dll" nocase

    condition:
        /*
         Logic:
         - Match when a majority of key DLLs are present (4 of the list) plus at least 2 GDI/shell APIs
           OR when 4 of the stronger API indicators appear (even without the DLL strings).
        */
        (
            4 of ($dll_gdiplus, $dll_winspool, $dll_msimg32, $dll_imagehlp, $dll_oledlg, $dll_oleacc, $dll_winmm) and
            2 of (
                $api_gdipcloneimage, $api_gdipaddpathlinei, $api_alphablend, $api_transparentblt,
                $api_realshellexecuteexw, $api_shgetdiskfreespaceexa, $api_pifmgrcloseproperties,
                $api_dllinstall, $api_shregcloseuskey, $api_urlunescapea, $api_pathsearchandqualifya,
                $api_symfindfileinpath, $api_symenumeratesymbols, $api_coreactivateobject,
                $api_stgmediumusermarshal, $api_registermessagepumphook, $api_mcigetdeviceidfromelementidw,
                $api_waveoutpause, $api_mmiosetinfo, $api_waveoutwrite, $api_vardatefromdisp,
                $api_vardecfromi4, $api_oleuiaddverbmenua, $api_oleuiobjectpropertiesa, $api_oleuiinsertobjectw,
                $api_oleuipromptuserw, $api_printersgetcommandrundll, $api_controltracew, $api_queryservicestatusex,
                $api_deregistereventsource, $api_pathappendw
            )
        )
        or
        (
            4 of (
                $api_gdipcloneimage, $api_gdipaddpathlinei, $api_alphablend, $api_transparentblt,
                $api_realshellexecuteexw, $api_shgetdiskfreespaceexa, $api_pifmgrcloseproperties,
                $api_dllinstall, $api_shregcloseuskey, $api_urlunescapea, $api_pathsearchandqualifya,
                $api_symfindfileinpath, $api_symenumeratesymbols, $api_coreactivateobject,
                $api_stgmediumusermarshal, $api_registermessagepumphook, $api_mcigetdeviceidfromelementidw,
                $api_waveoutpause, $api_mmiosetinfo, $api_waveoutwrite, $api_vardatefromdisp,
                $api_vardecfromi4, $api_oleuiaddverbmenua, $api_oleuiobjectpropertiesa, $api_oleuiinsertobjectw,
                $api_oleuipromptuserw, $api_printersgetcommandrundll, $api_controltracew, $api_queryservicestatusex,
                $api_deregistereventsource, $api_pathappendw
            )
        )
}
