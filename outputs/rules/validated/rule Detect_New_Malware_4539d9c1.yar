rule Detect_New_Malware_4539d9c1
{
    meta:
        description = "Detects text-log based malware sample 4539d9c1 and neighbors using specific API and DLL indicators related to shell integration and GUI manipulation."
        author = "malware-analyst"
        sha256 = "4539d9c199b2fb7c37b08ab4ef32c6edd3e3e26f53f2289fa6ef3eb970cf8970"
        created = "2023-10-27"

    strings:
        // Behavioral Indicators (APIs from new sample and neighbors)
        $api_callwindowproca = "callwindowproca"
        $api_getwindowlonga = "getwindowlonga"
        $api_setwindowlonga = "setwindowlonga"
        $api_shgetfileinfoa = "shgetfileinfoa"
        $api_shbrowseforfoldera = "shbrowseforfoldera"
        $api_shgetpathfromidlista = "shgetpathfromidlista"
        $api_shgetspecialfolderlocation = "shgetspecialfolderlocation"
        $api_shellexecuteexa = "shellexecuteexa"
        $api_shfileoperationa = "shfileoperationa"
        $api_findwindowexa = "findwindowexa"
        $api_imagelistaddmasked = "imagelistaddmasked"
        $api_iidfromstring = "iidfromstring"
        $api_messageboxindirecta = "messageboxindirecta"
        $api_dialogboxparama = "dialogboxparama"
        $api_createdialogparama = "createdialogparama"
        $api_getdlgitemtexta = "getdlgitemtexta"
        $api_setdlgitemtexta = "setdlgitemtexta"
        $api_sendmessagetimeouta = "sendmessagetimeouta"
        $api_setfilesecuritya = "setfilesecuritya"
        
        // Imported DLLs
        $dll_shell32 = "shell32.dll"
        $dll_comctl32 = "comctl32.dll"
        $dll_gdi32 = "gdi32.dll"
        $dll_user32 = "user32.dll"

        // Benign Filter strings (to avoid) - Implicitly handled by selection of specific APIs above which are absent in benign context provided.
        // However, explicit exclusion of purely generic combos is good practice if rule matches broadly. 
        // Based on provided negative context, the above APIs are not present.

    condition:
        // Logic: 
        // 1. Must include specific DLLs found in target (shell32, comctl32, gdi32) OR strong unique API indicators.
        // 2. Must utilize a subset of the unique behavioral APIs found in the target/neighbors but NOT in benign files.
        
        (
            $dll_shell32 and $dll_comctl32 and $dll_gdi32 and $dll_user32 and
            2 of ($api_callwindowproca, $api_getwindowlonga, $api_setwindowlonga, $api_shgetfileinfoa, $api_shbrowseforfoldera, $api_shgetpathfromidlista, $api_shgetspecialfolderlocation, $api_shellexecuteexa, $api_shfileoperationa, $api_findwindowexa, $api_imagelistaddmasked, $api_iidfromstring, $api_messageboxindirecta, $api_dialogboxparama, $api_createdialogparama, $api_getdlgitemtexta, $api_setdlgitemtexta, $api_sendmessagetimeouta, $api_setfilesecuritya)
        )
        or
        (
            4 of ($api_callwindowproca, $api_getwindowlonga, $api_setwindowlonga, $api_shgetfileinfoa, $api_shbrowseforfoldera, $api_shgetpathfromidlista, $api_shgetspecialfolderlocation, $api_shellexecuteexa, $api_shfileoperationa, $api_findwindowexa, $api_imagelistaddmasked, $api_iidfromstring, $api_messageboxindirecta, $api_dialogboxparama, $api_createdialogparama, $api_getdlgitemtexta, $api_setdlgitemtexta, $api_sendmessagetimeouta, $api_setfilesecuritya)
        )
}