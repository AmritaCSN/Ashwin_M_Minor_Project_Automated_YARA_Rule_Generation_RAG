rule Detect_New_Malware_3bcaf191
{
    meta:
        description = "Detects text-log based malware sample 3bcaf191 and neighbors using specific API and DLL indicators related to graphics and window manipulation."
        author = "malware-analyst"
        sha256 = "3bcaf191db8de9ae0926e3cc6c1e64b20187b1acdda8498c7856ac569e125204"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators */
        $api_oledraw = "oledraw" nocase
        $api_isaccelerator = "isaccelerator" nocase
        $api_createenhmetafilea = "createenhmetafilea" nocase
        $api_getenhmetafiledescriptiona = "getenhmetafiledescriptiona" nocase
        $api_getenhmetafilebits = "getenhmetafilebits" nocase
        $api_getenhmetafileheader = "getenhmetafileheader" nocase
        $api_getenhmetafilepaletteentries = "getenhmetafilepaletteentries" nocase
        $api_getwinmetafilebits = "getwinmetafilebits" nocase
        $api_playenhmetafile = "playenhmetafile" nocase
        $api_setenhmetafilebits = "setenhmetafilebits" nocase
        $api_setwinmetafilebits = "setwinmetafilebits" nocase
        $api_getkeynametexta = "getkeynametexta" nocase
        $api_imagelistreplace = "imagelistreplace" nocase
        $api_closeenhmetafile = "closeenhmetafile" nocase
        $api_copyenhmetafilea = "copyenhmetafilea" nocase
        $api_deleteenhmetafile = "deleteenhmetafile" nocase
        $api_drawstatea = "drawstatea" nocase
        $api_imagelistsetdragcursorimage = "imagelistsetdragcursorimage" nocase
        $api_winhelpa = "winhelpa" nocase
        $api_getmenuiteminfoa = "getmenuiteminfoa" nocase

        /* Larger indicator group */
        $api_imagelistgetimagecount = "imagelistgetimagecount" nocase
        $api_imagelistsetimagecount = "imagelistsetimagecount" nocase
        $api_imagelistadd = "imagelistadd" nocase
        $api_imagelistsetbkcolor = "imagelistsetbkcolor" nocase
        $api_imagelistgetbkcolor = "imagelistgetbkcolor" nocase
        $api_imagelistdraw = "imagelistdraw" nocase
        $api_imagelistdrawex = "imagelistdrawex" nocase
        $api_imagelistremove = "imagelistremove" nocase
        $api_imagelistbegindrag = "imagelistbegindrag" nocase
        $api_imagelistenddrag = "imagelistenddrag" nocase
        $api_imagelistdragenter = "imagelistdragenter" nocase
        $api_imagelistdragleave = "imagelistdragleave" nocase
        $api_imagelistdragmove = "imagelistdragmove" nocase
        $api_imagelistdragshownolock = "imagelistdragshownolock" nocase
        $api_imagelistread = "imagelistread" nocase
        $api_imagelistwrite = "imagelistwrite" nocase
        $api_imagelistseticonsize = "imagelistseticonsize" nocase
        $api_safearraygetelement = "safearraygetelement" nocase
        $api_safearrayputelement = "safearrayputelement" nocase
        $api_safearrayptrofindex = "safearrayptrofindex" nocase
        $api_initializeflatsb = "initializeflatsb" nocase
        $api_flatsbsetscrollprop = "flatsbsetscrollprop" nocase
        $api_flatsbsetscrollpos = "flatsbsetscrollpos" nocase
        $api_flatsbsetscrollinfo = "flatsbsetscrollinfo" nocase
        $api_flatsbgetscrollpos = "flatsbgetscrollpos" nocase
        $api_flatsbgetscrollinfo = "flatsbgetscrollinfo" nocase
        $api_extracticonw = "extracticonw" nocase
        $api_shchangenotify = "shchangenotify" nocase
        $api_inetisoffline = "inetisoffline" nocase
        $api_polypolyline = "polypolyline" nocase

        /* DLLs */
        $dll_comctl32 = "comctl32.dll" nocase
        $dll_gdi32 = "gdi32.dll" nocase
        $dll_comdlg32 = "comdlg32.dll" nocase
        $dll_winmm = "winmm.dll" nocase
        $dll_ole32 = "ole32.dll" nocase
        $dll_oleaut32 = "oleaut32.dll" nocase
        $dll_msimg32 = "msimg32.dll" nocase
        $dll_url = "url.dll" nocase
        $dll_opengl32 = "opengl32.dll" nocase

    condition:
        (
            /* Require at least 4 of these DLLs to avoid overfitting */
            4 of ($dll_comctl32, $dll_gdi32, $dll_comdlg32, $dll_winmm, $dll_ole32, $dll_oleaut32, $dll_msimg32, $dll_url, $dll_opengl32) and
            2 of (
                $api_oledraw, $api_isaccelerator, $api_createenhmetafilea, $api_getenhmetafiledescriptiona,
                $api_getenhmetafilebits, $api_getenhmetafileheader, $api_getenhmetafilepaletteentries,
                $api_getwinmetafilebits, $api_playenhmetafile, $api_setenhmetafilebits, $api_setwinmetafilebits,
                $api_getkeynametexta, $api_imagelistreplace, $api_closeenhmetafile, $api_copyenhmetafilea,
                $api_deleteenhmetafile, $api_drawstatea, $api_imagelistsetdragcursorimage, $api_winhelpa, $api_getmenuiteminfoa
            )
        )
        or
        (
            4 of (
                $api_imagelistgetimagecount, $api_imagelistsetimagecount, $api_imagelistadd, $api_imagelistsetbkcolor,
                $api_imagelistgetbkcolor, $api_imagelistdraw, $api_imagelistdrawex, $api_imagelistremove,
                $api_imagelistbegindrag, $api_imagelistenddrag, $api_imagelistdragenter, $api_imagelistdragleave,
                $api_imagelistdragmove, $api_imagelistdragshownolock, $api_imagelistread, $api_imagelistwrite,
                $api_imagelistseticonsize, $api_safearraygetelement, $api_safearrayputelement, $api_safearrayptrofindex,
                $api_initializeflatsb, $api_flatsbsetscrollprop, $api_flatsbsetscrollpos, $api_flatsbsetscrollinfo,
                $api_flatsbgetscrollpos, $api_flatsbgetscrollinfo, $api_extracticonw, $api_shchangenotify,
                $api_inetisoffline, $api_polypolyline
            )
        )
}
