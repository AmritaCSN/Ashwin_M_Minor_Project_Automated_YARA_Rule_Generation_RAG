rule Detect_New_Malware_21c6a81b1
{
    meta:
        description = "Detects text-log based malware sample 21c6a81b and neighbors using specific API and DLL indicators related to console manipulation and process control."
        author = "malware-analyst"
        sha256 = "21c6a81b4c605eef56076337cf15aadaeda20c634e9e472cf23d3c732da6e818"
        created = "2023-10-27"

    strings:
        // Behavioral Indicators (APIs from new sample and neighbors)
        $api_terminatethread = "terminatethread"
        $api_createmutexw = "createmutexw"
        $api_openeventa = "openeventa"
        $api_debugbreak = "debugbreak"
        $api_openmutexw = "openmutexw"
        $api_findnextvolumew = "findnextvolumew"
        $api_createtimerqueuetimer = "createtimerqueuetimer"
        $api_createiocompletionport = "createiocompletionport"
        $api_writeprivateprofilestringa = "writeprivateprofilestringa"
        $api_setprocesspriorityboost = "setprocesspriorityboost"
        $api_setthreadaffinitymask = "setthreadaffinitymask"
        $api_lockfile = "lockfile"
        $api_allocconsole = "allocconsole"
        $api_findfirstchangenotificationw = "findfirstchangenotificationw"
        $api_setprocessshutdownparameters = "setprocessshutdownparameters"
        $api_flushconsoleinputbuffer = "flushconsoleinputbuffer"
        $api_addatomw = "addatomw"
        $api_setconsolescreenbuffersize = "setconsolescreenbuffersize"
        $api_setconsolewindowinfo = "setconsolewindowinfo"
        $api_globalgetatomnamew = "globalgetatomnamew"
        $api_createmailslotw = "createmailslotw"
        $api_enumresourcenamesw = "enumresourcenamesw"
        $api_freelibraryandexitthread = "freelibraryandexitthread"
        $api_createtimerqueue = "createtimerqueue"
        $api_enumresourcetypesw = "enumresourcetypesw"
        $api_getsystemwow64directoryw = "getsystemwow64directoryw"
        $api_writeconsoleinputa = "writeconsoleinputa"
        $api_waitfordebugevent = "waitfordebugevent"
        $api_copyfileexw = "copyfileexw"
        $api_fillconsoleoutputcharacterw = "fillconsoleoutputcharacterw"
        $api_querydepthslist = "querydepthslist"
        $api_readconsoleinputw = "readconsoleinputw"
        $api_setlocaleinfow = "setlocaleinfow"
        $api_getconsolealiaseslengthw = "getconsolealiaseslengthw"
        $api_buildcommdcbandtimeoutsw = "buildcommdcbandtimeoutsw"
        $api_resetwritewatch = "resetwritewatch"
        $api_callnamedpipea = "callnamedpipea"
        $api_buildcommdcbandtimeoutsa = "buildcommdcbandtimeoutsa"
        $api_getconsolealiasexesa = "getconsolealiasexesa"
        $api_setdefaultcommconfigw = "setdefaultcommconfigw"
        $api_getnamedpipehandlestatea = "getnamedpipehandlestatea"
        $api_buildcommdcbw = "buildcommdcbw"
        $api_openwaitabletimerw = "openwaitabletimerw"
        $api_setcomputernamea = "setcomputernamea"
        $api_getbinarytypew = "getbinarytypew"
        $api_setcalendarinfow = "setcalendarinfow"
        $api_verlanguagenamew = "verlanguagenamew"
        $api_getnumberformata = "getnumberformata"
        $api_getsystemtimeadjustment = "getsystemtimeadjustment"
        $api_getcompressedfilesizea = "getcompressedfilesizea"
        $api_getcommstate = "getcommstate"
        $api_getconsolealiasexeslengtha = "getconsolealiasexeslengtha"
        $api_findnextvolumemountpointa = "findnextvolumemountpointa"
        $api_writeconsoleoutputcharactera = "writeconsoleoutputcharactera"
        $api_readconsoleoutputcharactera = "readconsoleoutputcharactera"
        $api_getcommconfig = "getcommconfig"
        $api_initatomtable = "initatomtable"
        $api_setconsolecursorinfo = "setconsolecursorinfo"
        $api_createactctxa = "createactctxa"
        $api_writeprivateprofilestructw = "writeprivateprofilestructw"
        $api_globalunfix = "globalunfix"
        $api_convertfibertothread = "convertfibertothread"
        $api_movefilewithprogressw = "movefilewithprogressw"
        
        // Imported DLLs
        $dll_kernel32 = "kernel32.dll"
        // $dll_user32 = "user32.dll" // Common, but present in neighbors

        // Benign Filter strings (to avoid) - Implicitly handled by selection of specific APIs above which are absent in benign context provided.
        // However, explicit exclusion of purely generic combos is good practice if rule matches broadly. 
        // Based on provided negative context, the above APIs are not present.

    condition:
        // Logic: 
        // 1. Must include specific DLL "kernel32.dll" (found in target) AND strong unique API indicators.
        // 2. Must utilize a subset of the unique behavioral APIs found in the target/neighbors but NOT in benign files.
        
        $dll_kernel32 and
        (
            2 of ($api_terminatethread, $api_createmutexw, $api_openeventa, $api_debugbreak, $api_openmutexw, $api_findnextvolumew) or
            4 of ($api_createtimerqueuetimer, $api_createiocompletionport, $api_writeprivateprofilestringa, $api_setprocesspriorityboost, $api_setthreadaffinitymask, $api_lockfile, $api_allocconsole, $api_findfirstchangenotificationw, $api_setprocessshutdownparameters, $api_flushconsoleinputbuffer, $api_addatomw, $api_setconsolescreenbuffersize, $api_setconsolewindowinfo, $api_globalgetatomnamew, $api_createmailslotw, $api_enumresourcenamesw, $api_freelibraryandexitthread, $api_createtimerqueue, $api_enumresourcetypesw, $api_getsystemwow64directoryw, $api_writeconsoleinputa, $api_waitfordebugevent, $api_copyfileexw, $api_fillconsoleoutputcharacterw, $api_querydepthslist, $api_readconsoleinputw, $api_setlocaleinfow, $api_getconsolealiaseslengthw, $api_buildcommdcbandtimeoutsw, $api_resetwritewatch, $api_callnamedpipea, $api_buildcommdcbandtimeoutsa, $api_getconsolealiasexesa, $api_setdefaultcommconfigw, $api_getnamedpipehandlestatea, $api_buildcommdcbw, $api_openwaitabletimerw, $api_setcomputernamea, $api_getbinarytypew, $api_setcalendarinfow, $api_verlanguagenamew, $api_getnumberformata, $api_getsystemtimeadjustment, $api_getcompressedfilesizea, $api_getcommstate, $api_getconsolealiasexeslengtha, $api_findnextvolumemountpointa, $api_writeconsoleoutputcharactera, $api_readconsoleoutputcharactera, $api_getcommconfig, $api_initatomtable, $api_setconsolecursorinfo, $api_createactctxa, $api_writeprivateprofilestructw, $api_globalunfix, $api_convertfibertothread, $api_movefilewithprogressw)
        )
}