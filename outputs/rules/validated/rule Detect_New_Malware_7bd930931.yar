rule Detect_New_Malware_7bd93093
{
    meta:
        description = "Detects text-log based malware sample 7bd93093 and neighbors using specific API and DLL indicators."
        author = "malware-analyst"
        sha256 = "7bd930935f5318bf8b9b0905536d0183a43a58100ea9af549dfcbe79417f3cc1"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators (APIs from new sample and neighbors) */
        $api_enumres            = "enumresourcenamesw" nocase
        $api_updateres          = "updateresourcew" nocase
        $api_endupdateres       = "endupdateresourcew" nocase
        $api_module32           = "module32nextw" nocase
        $api_createremote       = "createremotethread" nocase
        $api_actctx_string      = "findactctxsectionstringw" nocase
        $api_actctx_guid        = "findactctxsectionguid" nocase
        $api_console_input      = "peekconsoleinputw" nocase
        $api_console_read       = "readconsoleinputw" nocase
        $api_console_aliases    = "getconsolealiaseslengtha" nocase
        $api_profile_sect       = "getprofilesectionw" nocase
        $api_copyfileex         = "copyfileexw" nocase
        $api_createsem          = "createsemaphorew" nocase
        $api_createnamedpipe    = "createnamedpipew" nocase
        $api_debugbreak         = "debugbreak" nocase
        $api_globalwire         = "globalwire" nocase
        $api_privprofile        = "getprivateprofileintw" nocase
        $api_cancelwait         = "cancelwaitabletimer" nocase
        $api_setthreadcontext   = "setthreadcontext" nocase
        $api_isbadreadptr       = "isbadreadptr" nocase

        /* Imported DLLs (contextual) */
        $dll_kernel32 = "kernel32.dll" nocase
        $dll_user32   = "user32.dll" nocase

    condition:
        /*
         Logic:
         - Match when resource-modification indicators (2 of 3) + at least one strong injection/process signal
           (and at least one of the contextual DLLs) OR when 4 of the broader set of indicators appear.
        */
        (
            2 of ($api_enumres, $api_updateres, $api_endupdateres) and
            1 of ($api_createremote, $api_module32, $api_setthreadcontext) and
            1 of ($dll_kernel32, $dll_user32)
        )
        or
        (
            4 of (
                $api_actctx_string, $api_actctx_guid, $api_console_input, $api_console_read,
                $api_console_aliases, $api_profile_sect, $api_copyfileex, $api_createsem,
                $api_createnamedpipe, $api_debugbreak, $api_globalwire, $api_privprofile,
                $api_cancelwait, $api_isbadreadptr
            )
        )
}
