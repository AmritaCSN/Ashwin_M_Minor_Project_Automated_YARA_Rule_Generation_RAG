rule Detect_Native_Malware_Behavioral
{
    meta:
        description = "Detects Native Malware using Synchronization (OpenSemaphore) combined with process injection/persistence techniques. Replaces standard MSVC compiler artifacts with behavioral indicators."
        author = "malware-analyst"
        date = "2025-12-01"
        confidence = "Medium"

    strings:
        /* 1. Synchronization (The Anchor) */
        // Malware often uses Semaphores or Mutexes to avoid infecting the same machine twice
        $sync_1 = "opensemaphore" 
        $sync_2 = "createmutex"

        /* 2. Injection/Loader Capabilities (The Malicious Context) */
        // Look for these occurring alongside the synchronization
        $inject_1 = "writeprocessmemory"
        $inject_2 = "createremotethread"
        $inject_3 = "virtualprotect"      // Changing memory permissions (very common in packers)
        $inject_4 = "setthreadcontext"

        /* 3. Persistence/Stealth */
        $persist_1 = "regopenkey"
        $persist_2 = "winexec"
        $persist_3 = "shellexecute"

        /* 4. Benign Filters */
        $safe_1 = "Microsoft Corporation"
        $safe_2 = "Visual Studio"  // Filter out debug/dev tools that might have these

    condition:
        /* LOGIC:
           1. Must verify synchronization (OpenSemaphore or CreateMutex)
           2. AND must show signs of Injection or heavy Persistence
           3. AND must not be a known safe file
        */
        
        any of ($sync_*) 
        
        and (
            2 of ($inject_*) or 
            2 of ($persist_*)
        )
        
        and not any of ($safe_*)
}