rule Detect_New_Malware_39698495
{
    meta:
        description = "Detects text-log based malware sample 39698495 and neighbors using specific VB6 runtime and API indicators."
        author = "malware-analyst"
        sha256 = "3969849500b4456d9b648eeaf3f471fcbfeea14e323d3db643fc628b9ee2a586"
        created = "2023-10-27"

    strings:
        // Behavioral Indicators (APIs from new sample and neighbors) - VB6 runtime
        $vb_vbarecansitouni = "vbarecansitouni"
        $vb_vbasetsystemerror = "vbasetsystemerror"
        $vb_vbarecunitoansi = "vbarecunitoansi"
        $vb_vbastrtoansi = "vbastrtoansi"
        $vb_vbacastobj = "vbacastobj"
        $vb_vbainstr = "vbainstr"
        $vb_vbarecdestruct = "vbarecdestruct"
        $vb_vbarecdestructansi = "vbarecdestructansi"
        $vb_vbavaridiv = "vbavaridiv"
        $vb_vbaaryconstruct2 = "vbaaryconstruct2"
        $vb_vbai2str = "vbai2str"
        $vb_vbalateidst = "vbalateidst"
        $vb_vbavartstne = "vbavartstne"
        $vb_vbalatememcall = "vbalatememcall"
        $vb_vbalatememst = "vbalatememst"
        $vb_vbavarsetobj = "vbavarsetobj"
        $vb_vbalatememcallld = "vbalatememcallld"
        
        // Behavioral Indicators - General APIs
        // None specific to the target or neighbors that are absent in benign context were highlighted beyond standard VB6.
        // Focusing on VB6 specific calls.

        // Imported DLLs
        $dll_msvbvm60 = "msvbvm60.dll"

        // Benign Filter strings (to avoid) - Implicitly handled by selection of specific APIs above which are absent in benign context provided.
        // However, explicit exclusion of purely generic combos is good practice if rule matches broadly. 
        // Based on provided negative context, the above APIs are not present.

    condition:
        // Logic: 
        // 1. Must include specific DLL "msvbvm60.dll" (found in target) AND strong unique API indicators.
        // 2. Must utilize a subset of the unique behavioral APIs found in the target/neighbors but NOT in benign files.
        
        $dll_msvbvm60 and
        (
            2 of ($vb_vbarecansitouni, $vb_vbasetsystemerror, $vb_vbarecunitoansi, $vb_vbastrtoansi, $vb_vbacastobj, $vb_vbainstr, $vb_vbarecdestruct, $vb_vbarecdestructansi, $vb_vbavaridiv)
        )
        or
        (
            4 of ($vb_vbaaryconstruct2, $vb_vbai2str, $vb_vbalateidst, $vb_vbavartstne, $vb_vbalatememcall, $vb_vbalatememst, $vb_vbavarsetobj, $vb_vbalatememcallld, $vb_vbarecansitouni, $vb_vbasetsystemerror, $vb_vbarecunitoansi, $vb_vbastrtoansi, $vb_vbacastobj, $vb_vbainstr, $vb_vbarecdestruct, $vb_vbarecdestructansi, $vb_vbavaridiv)
        )
}