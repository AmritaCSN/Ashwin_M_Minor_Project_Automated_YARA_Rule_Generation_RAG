rule VB_Malware_msvbvm60_behavioral
{
    meta:
        author = "malware-analyst"
        description = "Detects VB6/MSVBVM60-based samples showing behavioral/runtime indicators (P/Invoke-like and event sink usage). Designed to avoid generic CRT/kernel artifacts."
        sha256_new_sample = "8a91203698a5589c1787d9fb31dbbc30ab3229a6aee56992f9186a4d4fc4ae2c"
        date = "2025-12-01"
        reference = "Derived from comparison with multiple VB6 malware neighbors; excludes generic C/C++ runtime indicators."

    strings:
        $msvb              = "msvbvm60.dll"
        $dllfunc           = "dllfunctioncall"
        $ev_qi             = "eventsinkqueryinterface"
        $ev_addref         = "eventsinkaddref"
        $ev_release        = "eventsinkrelease"
        $vba_except        = "vbaexcepthandler"
        $vb_freevarlist    = "vbafreevarlist"
        $vbastr_to_ansi    = "vbastrtoansi"
        $vbastr_to_unicode = "vbastrtounicode"
        $vbastr_copy       = "vbastrcopy"
        $vb_free_str_list  = "vbafreestrlist"
        $vb_free_obj       = "vbafreeobj"

    condition:
        /* Must include the VB runtime DLL name AND multiple VB behavioral/runtime indicators.
           Requiring several indicators reduces false positives from benign files that may include
           common CRT/kernel strings. */
        $msvb and 4 of ($dllfunc, $ev_qi, $ev_addref, $ev_release, $vba_except, $vb_freevarlist, $vbastr_to_ansi, $vbastr_to_unicode, $vbastr_copy, $vb_free_str_list, $vb_free_obj)
}
