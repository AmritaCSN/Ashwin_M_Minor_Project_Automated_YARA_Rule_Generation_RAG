rule Detect_New_Malware_1d4e04fe_tuned
{
    meta:
        description = "Tuned: Detects cluster 1d4e04fe â€” require two DLL anchors + resource API + behavioral indicator (memory/thread/UI). Reduced FP while keeping TP."
        author = "malware-analyst (tuned)"
        sha256 = "1d4e04fe6e9b4cb7a87f57ebebdf6b66d3eed4bae5d97c4cf36d39641928c723"
        created = "2023-10-27"
        tuned = "2025-12-05"
        confidence = "Medium"

    strings:
        /* DLL anchors (require 2 of 3) */
        $dll_shlwapi      = "shlwapi.dll" nocase
        $dll_gdi32        = "gdi32.dll" nocase
        $dll_comdlg32     = "comdlg32.dll" nocase

        /* Resource / embedding APIs (require 1) */
        $res_lock         = "lockresource" nocase
        $res_sizeof       = "sizeofresource" nocase
        $res_load         = "loadresource" nocase
        $res_find_a       = "findresourcea" nocase

        /* Behavioral / higher-confidence indicators (require 1) */
        $mem_vprot        = "virtualprotect" nocase
        $thr_create       = "createthread" nocase
        $interlocked_cmp  = "interlockedcompareexchange" nocase
        $wait_multi       = "waitformultipleobjects" nocase

        /* Useful UI/context tokens (captured indirectly via requirement counts) */
        $ui_getopen       = "getopenfilenamea" nocase
        $ui_dialogparam   = "dialogboxparama" nocase
        $ui_messagebox    = "messageboxa" nocase
        $ui_loadicon      = "loadicona" nocase
        $ui_loadbitmap    = "loadbitmapa" nocase

    condition:
        /*
         * TUNED LOGIC:
         * - Require at least two DLL anchors to reduce incidental matches
         * - Require at least one resource-related API (embedding/resource handling)
         * - Require at least one behavioral indicator showing memory/threading/atomic ops
         *
         * Additionally allow a fallback match for variants that emphasize UI + resource:
         * - (two DLL anchors) AND (3 of UI/resource tokens) AND (1 behavioral indicator)
         */
        2 of ( $dll_shlwapi, $dll_gdi32, $dll_comdlg32 ) and
        (
            /* primary path: resource + behavior */
            ( 1 of ( $res_lock, $res_sizeof, $res_load, $res_find_a ) and
              1 of ( $mem_vprot, $thr_create, $interlocked_cmp, $wait_multi ) )
            or
            /* fallback path: UI-heavy variant + resource + behavior */
            ( 3 of ( $ui_getopen, $ui_dialogparam, $ui_messagebox, $ui_loadicon, $ui_loadbitmap, $res_lock, $res_sizeof, $res_load, $res_find_a ) and
              1 of ( $mem_vprot, $thr_create, $interlocked_cmp, $wait_multi ) )
        )
}
