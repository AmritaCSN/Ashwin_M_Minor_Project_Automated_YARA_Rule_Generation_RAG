rule Detect_DotNet_Packed_Behavioral
{
    meta:
        description = "Detects .NET executables using P/Invoke (Native APIs) typical of Packers/Unpackers. Replaces brittle header size checks."
        author = "malware-analyst"
        date = "2025-12-01"
        confidence = "Medium"

    strings:
        /* 1. Context: .NET Markers */
        $dotnet_1 = "mscoree.dll"
        $dotnet_2 = "corexemain"

        /* 2. The Behavior: Unpacking APIs (P/Invoke strings) */
        // Packers must change memory permissions to execute the unpacked payload.
        $packer_1 = "virtualprotect"      // Changes memory to Read/Write/Execute
        $packer_2 = "virtualalloc"        // Allocates memory for payload
        $packer_3 = "getprocaddress"      // Dynamic API resolution
        $packer_4 = "loadlibrary"         // Loading plugins/dependencies
        $packer_5 = "writeprocessmemory"  // Writing payload to memory

        /* 3. Benign Filters */
        $safe_1   = "Microsoft Corporation"
        $safe_2   = "Windows System"
        $safe_3   = "Assembly Copyright" 

    condition:
        /* LOGIC:
           1. Must be a .NET file
           2. AND must use 'VirtualProtect' (High signal for .NET packers) OR 2 other unpacking APIs
           3. AND must not be a known safe file
        */
        all of ($dotnet_*)
        
        and (
            $packer_1 or           // VirtualProtect is the strongest indicator
            2 of ($packer_*)       // OR a combination of others
        )
        
        and not any of ($safe_*)
}