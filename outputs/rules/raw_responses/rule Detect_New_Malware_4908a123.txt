rule Detect_New_Malware_4908a123
{
    meta:
        description = "Detects text-log based malware sample 4908a123 and neighbors using specific API and DLL indicators related to console manipulation and debugging."
        author = "malware-analyst"
        sha256 = "4908a123314e068f7823c102f4de7c4445b62a5ca191b1c495b782da75bd1627"
        created = "2023-10-27"

    strings:
        // Behavioral Indicators (APIs from new sample and neighbors)
        $api_setthreadpriority = "setthreadpriority"
        $api_terminatethread = "terminatethread" // Found in neighbors
        $api_debugactiveprocessstop = "debugactiveprocessstop"
        $api_wtsgetactiveconsolesessionid = "wtsgetactiveconsolesessionid"
        $api_debugsetprocesskillonexit = "debugsetprocesskillonexit" // Found in neighbor 2
        $api_createactctx = "createactctxa" // Matches createactctxw and createactctxa
        $api_queryactctx = "queryactctxw" // Found in neighbor 2
        $api_addrefactctx = "addrefactctx" // Found in neighbor 2 and 3
        $api_releaseactctx = "releaseactctx"
        $api_activateactctx = "activateactctx" // Found in neighbor 3
        $api_deactivateactctx = "deactivateactctx" // Found in neighbor 3
        $api_createtimerqueue = "createtimerqueue"
        $api_changetimerqueuetimer = "changetimerqueuetimer"
        $api_canceltimerqueuetimer = "canceltimerqueuetimer" // Found in neighbor 1
        $api_createtimerqueuetimer = "createtimerqueuetimer" // Found in neighbors
        $api_getconsolealiaseslength = "getconsolealiaseslengthw" // Matches w and a
        $api_getconsolealiasexeslength = "getconsolealiasexeslengthw" // Matches w and a
        $api_readconsoleoutput = "readconsoleoutputw" // Matches w and a
        $api_writeconsoleoutput = "writeconsoleoutputa" // Matches w and a
        $api_readconsoleinput = "readconsoleinputw" // Matches w and a
        $api_writeconsoleinput = "writeconsoleinputa" // Matches w and a
        $api_getconsolealias = "getconsolealiasw" // Matches w and a
        $api_addconsolealias = "addconsolealiasa" // Matches w and a
        $api_getcommconfig = "getcommconfig"
        $api_setcommstate = "setcommstate" // Found in neighbor 1
        $api_buildcommdcb = "buildcommdcbw" // Matches w and a
        $api_buildcommdcbandtimeouts = "buildcommdcbandtimeoutsw" // Matches w and a
        $api_globalunfix = "globalunfix"
        $api_globalfix = "globalfix"
        $api_globalwire = "globalwire" // Found in neighbor 1 and 2
        $api_globalunwire = "globalunwire" // Found in neighbor 3
        $api_convertfibertothread = "convertfibertothread"
        $api_mapuserphysicalpagesscatter = "mapuserphysicalpagesscatter"
        $api_freeuserphysicalpages = "freeuserphysicalpages" // Found in neighbor 1 and 2
        $api_enumresourcetypes = "enumresourcetypesa" // Matches w and a
        $api_beginupdateresource = "beginupdateresourcew" // Matches w and a
        $api_endupdateresource = "endupdateresourcew" // Matches w and a
        $api_findfirstchangenotification = "findfirstchangenotificationa" // Matches w and a
        $api_findnextchangenotification = "findnextchangenotification" // Found in neighbor 3
        
        // Imported DLLs
        $dll_kernel32 = "kernel32.dll"
        // $dll_user32 = "user32.dll" // Common, but present in neighbors

        // Benign Filter strings (to avoid) - Implicitly handled by selection of specific APIs above which are absent in benign context provided.
        // However, explicit exclusion of purely generic combos is good practice if rule matches broadly. 
        // Based on provided negative context, the above APIs are not present.

    condition:
        // Logic: 
        // 1. Must include specific DLL "kernel32.dll" (found in target) AND strong unique API indicators.
        // 2. Must utilize a subset of the unique behavioral APIs found in the target/neighbors but NOT in benign files.
        
        $dll_kernel32 and
        (
            2 of ($api_debugactiveprocessstop, $api_wtsgetactiveconsolesessionid, $api_debugsetprocesskillonexit, $api_convertfibertothread, $api_mapuserphysicalpagesscatter) or
            4 of ($api_setthreadpriority, $api_terminatethread, $api_createactctx, $api_queryactctx, $api_addrefactctx, $api_releaseactctx, $api_activateactctx, $api_deactivateactctx, $api_createtimerqueue, $api_changetimerqueuetimer, $api_canceltimerqueuetimer, $api_createtimerqueuetimer, $api_getconsolealiaseslength, $api_getconsolealiasexeslength, $api_readconsoleoutput, $api_writeconsoleoutput, $api_readconsoleinput, $api_writeconsoleinput, $api_getconsolealias, $api_addconsolealias, $api_getcommconfig, $api_setcommstate, $api_buildcommdcb, $api_buildcommdcbandtimeouts, $api_globalunfix, $api_globalfix, $api_globalwire, $api_globalunwire, $api_freeuserphysicalpages, $api_enumresourcetypes, $api_beginupdateresource, $api_endupdateresource, $api_findfirstchangenotification, $api_findnextchangenotification)
        )
}