rule Detect_New_Malware_78c73948
{
    meta:
        description = "Detects text-log based malware sample 78c73948 and neighbors using specific API and DLL indicators related to process and thread manipulation, console handling, and system information."
        author = "malware-analyst"
        sha256 = "78c7394887732f5bcf85b2384010b2676edd17aa597c8d95e3ff47b50415dfe0"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators (APIs from new sample and neighbors) */
        $api_process32firstw            = "process32firstw" nocase
        $api_process32nextw             = "process32nextw" nocase
        $api_createtoolhelp32snapshot   = "createtoolhelp32snapshot" nocase
        $api_setthreadpriority          = "setthreadpriority" nocase
        $api_setthreadaffinitymask      = "setthreadaffinitymask" nocase
        $api_terminatethread            = "terminatethread" nocase
        $api_getexitcodethread          = "getexitcodethread" nocase
        $api_getexitcodeprocess         = "getexitcodeprocess" nocase
        $api_readprocessmemory          = "readprocessmemory" nocase
        $api_writeprocessmemory         = "writeprocessmemory" nocase
        $api_virtualallocex             = "virtualallocex" nocase
        $api_createremotethread         = "createremotethread" nocase
        $api_createfilemappinga         = "createfilemappinga" nocase
        $api_openfilemappinga           = "openfilemappinga" nocase
        $api_mapviewoffile              = "mapviewoffile" nocase
        $api_unmapviewoffile            = "unmapviewoffile" nocase
        $api_getconsoleoutputcp         = "getconsoleoutputcp" nocase
        $api_setconsolemode             = "setconsolemode" nocase
        $api_getconsolemode             = "getconsolemode" nocase
        $api_getconsolecp               = "getconsolecp" nocase
        $api_writeconsolew              = "writeconsolew" nocase
        $api_readconsolew               = "readconsolew" nocase
        $api_flushconsoleinputbuffer    = "flushconsoleinputbuffer" nocase
        $api_peekconsoleinputa          = "peekconsoleinputa" nocase
        $api_readconsoleinputw          = "readconsoleinputw" nocase
        $api_writeconsoleinputa         = "writeconsoleinputa" nocase
        $api_getconsolealiaseslengthw   = "getconsolealiaseslengthw" nocase
        $api_getconsolealiasexeslengthw = "getconsolealiasexeslengthw" nocase
        $api_getconsolealiasesw         = "getconsolealiasesw" nocase
        $api_getconsolealiasa           = "getconsolealiasa" nocase
        $api_addconsolealiasa           = "addconsolealiasa" nocase
        $api_getconsoletitlea           = "getconsoletitlea" nocase
        $api_setconsoletitlea           = "setconsoletitlea" nocase
        $api_getconsolewindow           = "getconsolewindow" nocase
        $api_getconsolescreenbufferinfo = "getconsolescreenbufferinfo" nocase
        $api_setconsolescreenbuffersize = "setconsolescreenbuffersize" nocase
        $api_setconsolewindowinfo       = "setconsolewindowinfo" nocase
        $api_setconsolecursorposition   = "setconsolecursorposition" nocase
        $api_setconsolecursorinfo       = "setconsolecursorinfo" nocase
        $api_fillconsoleoutputcharacterw= "fillconsoleoutputcharacterw" nocase
        $api_readconsoleoutputcharactera = "readconsoleoutputcharactera" nocase
        $api_writeconsoleoutputcharacterw = "writeconsoleoutputcharacterw" nocase
        $api_gettitlebarinfo            = "gettitlebarinfo" nocase
        $api_getsystemwindowsdirectoryw = "getsystemwindowsdirectoryw" nocase
        $api_getsystemwow64directoryw   = "getsystemwow64directoryw" nocase
        $api_getsystemwow64directorya   = "getsystemwow64directorya" nocase
        $api_winhttpreaddata            = "winhttpreaddata" nocase

        /* Imported DLLs */
        $dll_kernel32 = "kernel32.dll" nocase
        $dll_user32   = "user32.dll" nocase
        $dll_winhttp  = "winhttp.dll" nocase

    condition:
        /*
         Logic:
         - Match when key DLLs are present AND at least two strong process/injection indicators (to reduce false positives),
           OR when 4 of the broader set of process/console/system indicators are present.
        */
        (
            $dll_kernel32 and $dll_user32 and $dll_winhttp and
            2 of (
                $api_process32firstw, $api_process32nextw, $api_readprocessmemory,
                $api_writeprocessmemory, $api_virtualallocex, $api_createremotethread,
                $api_createtoolhelp32snapshot, $api_winhttpreaddata
            )
        )
        or
        (
            4 of (
                $api_setthreadpriority, $api_setthreadaffinitymask, $api_terminatethread,
                $api_getexitcodethread, $api_getexitcodeprocess, $api_createfilemappinga,
                $api_openfilemappinga, $api_mapviewoffile, $api_unmapviewoffile,
                $api_getconsoleoutputcp, $api_setconsolemode, $api_getconsolemode,
                $api_getconsolecp, $api_writeconsolew, $api_readconsolew,
