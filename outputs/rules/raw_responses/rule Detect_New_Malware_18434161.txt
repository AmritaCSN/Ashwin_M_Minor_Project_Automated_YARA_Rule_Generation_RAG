rule Detect_New_Malware_18434161
{
    meta:
        description = "Detects text-log based malware sample 18434161 and neighbors using specific API and DLL indicators related to MFC and GDI."
        author = "malware-analyst"
        sha256 = "184341613158f5244ea0e838f4ae1383748573cae4740558e272699dd623afe5"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators (APIs from new sample and neighbors) */
        $api_isiconic        = "isiconic" nocase
        $api_escape          = "escape" nocase

        /* Contextual APIs (Present in target but common, used for context) */
        $api_getprocaddress  = "getprocaddress" nocase
        $api_loadlibrarya    = "loadlibrarya" nocase
        $api_virtualalloc    = "virtualalloc" nocase
        $api_virtualprotect  = "virtualprotect" nocase

        /* Imported DLLs */
        $dll_mfc42           = "mfc42.dll" nocase
        $dll_gdi32           = "gdi32.dll" nocase
        $dll_user32          = "user32.dll" nocase

    condition:
        /*
         Logic:
         - Require presence of MFC + GDI + User32
         - Require the uncommon behavioral pair IsIconic + Escape
         - And at least one of the contextual APIs that indicate dynamic resolution or memory staging
        */
        $dll_mfc42 and $dll_gdi32 and $dll_user32 and
        $api_isiconic and $api_escape and
        ( $api_getprocaddress or $api_loadlibrarya or $api_virtualalloc or $api_virtualprotect )
}
