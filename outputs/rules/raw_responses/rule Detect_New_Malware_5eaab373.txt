rule Detect_New_Malware_5eaab373
{
    meta:
        description = "Detects text-log based malware sample 5eaab373 and neighbors using specific VB6 runtime and API indicators."
        author = "malware-analyst"
        sha256 = "5eaab373081a16275f8a096bdb725f1d9fccc3e6a93b2ca637f7b5cfe7026e2f"
        created = "2023-10-27"

    strings:
        /* Behavioral Indicators (VB6 runtime / helpers) */
        $api_cisqrt                     = "cisqrt" nocase
        $api_cisin                      = "cisin" nocase
        $api_cicos                      = "cicos" nocase
        $api_adjfptan                   = "adjfptan" nocase
        $api_vbavarmove                 = "vbavarmove" nocase
        $api_vbafreevar                 = "vbafreevar" nocase
        $api_vbafreevarlist             = "vbafreevarlist" nocase
        $api_adjfdivm64                 = "adjfdivm64" nocase
        $api_vbafreeobjlist             = "vbafreeobjlist" nocase
        $api_adjfprem1                  = "adjfprem1" nocase
        $api_vbastrcat                  = "vbastrcat" nocase
        $api_vbahresultcheckobj         = "vbahresultcheckobj" nocase
        $api_adjfdivm32                 = "adjfdivm32" nocase
        $api_vbaarydestruct             = "vbaarydestruct" nocase
        $api_vbaobjset                  = "vbaobjset" nocase
        $api_adjfdivm16i                = "adjfdivm16i" nocase
        $api_vbaobjsetaddref            = "vbaobjsetaddref" nocase
        $api_adjfdivrm16i               = "adjfdivrm16i" nocase
        $api_vbaerase                   = "vbaerase" nocase
        $api_vbachkstk                  = "vbachkstk" nocase
        $api_eventsinkaddref            = "eventsinkaddref" nocase
        $api_vbastrcmp                  = "vbastrcmp" nocase
        $api_vbavartsteq                = "vbavartsteq" nocase
        $api_vbaobjvar                  = "vbaobjvar" nocase
        $api_vbai2i4                    = "vbai2i4" nocase
        $api_vbacastobjvar              = "vbacastobjvar" nocase
        $api_adjfpatan                  = "adjfpatan" nocase
        $api_vbaredim                   = "vbaredim" nocase
        $api_eventsinkrelease           = "eventsinkrelease" nocase
        $api_vbaui1i2                   = "vbaui1i2" nocase
        $api_eventsinkqueryinterface    = "eventsinkqueryinterface" nocase
        $api_vbaexcepthandler           = "vbaexcepthandler" nocase
        $api_adjfprem                   = "adjfprem" nocase
        $api_adjfdivrm64                = "adjfdivrm64" nocase
        $api_vbafpexception             = "vbafpexception" nocase
        $api_cilog                      = "cilog" nocase
        $api_vbanew2                    = "vbanew2" nocase
        $api_adjfdivm32i                = "adjfdivm32i" nocase
        $api_adjfdivrm32i               = "adjfdivrm32i" nocase
        $api_vbastrcopy                 = "vbastrcopy" nocase
        $api_vbai4str                   = "vbai4str" nocase
        $api_vbafreestrlist             = "vbafreestrlist" nocase
        $api_adjfdivrm32                = "adjfdivrm32" nocase
        $api_adjfdivr                   = "adjfdivr" nocase
        $api_vbavardup                  = "vbavardup" nocase
        $api_vbavarlatememcallld        = "vbavarlatememcallld" nocase
        $api_ciatan                     = "ciatan" nocase
        $api_vbastrmove                 = "vbastrmove" nocase
        $api_allmul                     = "allmul" nocase
        $api_citan                      = "citan" nocase
        $api_ciexp                      = "ciexp" nocase
        $api_vbafreeobj                 = "vbafreeobj" nocase
        $api_vbafreestr                 = "vbafreestr" nocase
        $api_vbaarymove                 = "vbaarymove" nocase
        $api_vbastrvarmove              = "vbastrvarmove" nocase
        $api_vbagenerateboundserror     = "vbagenerateboundserror" nocase
        $api_vbai2str                   = "vbai2str" nocase
        $api_vbavar2vec                 = "vbavar2vec" nocase
        $api_vbar8str                   = "vbar8str" nocase
        $api_vbai4var                   = "vbai4var" nocase
        $api_vbalatememcall             = "vbalatememcall" nocase
        $api_vbaend                     = "vbaend" nocase
        $api_vbai2var                   = "vbai2var" nocase
        $api_vbastrvarval               = "vbastrvarval" nocase
        $api_vbavaradd                  = "vbavaradd" nocase
        $api_vbacastobj                 = "vbacastobj" nocase
        $api_vbavarlatememst            = "vbavarlatememst" nocase
        $api_vbaerroroverflow           = "vbaerroroverflow" nocase
        $api_vbastri2                   = "vbastri2" nocase
        $api_vbafpint                   = "vbafpint" nocase
        $api_sysreallocstring           = "sysreallocstring" nocase
        $api_vbaubound                  = "vbaubound" nocase
        $api_vbalenvarb                 = "vbalenvarb" nocase
        $api_vbafpi2                    = "vbafpi2" nocase
        $api_vbavarlatememcallldrf      = "vbavarlatememcallldrf" nocase
        $api_vbastrfixstr               = "vbastrfixstr" nocase
        $api_vbastrr4                   = "vbastrr4" nocase
        $api_vbai4errvar                = "vbai4errvar" nocase
        $api_vbafpr4                    = "vbafpr4" nocase
        $api_vbalbound                  = "vbalbound" nocase
        $api_vbalsetfixstr              = "vbalsetfixstr" nocase
        $api_vbaarylock                 = "vbaarylock" nocase
        $api_vbavarlatememcallst        = "vbavarlatememcallst" nocase
        $api_vbaaryunlock               = "vbaaryunlock" nocase
        $api_vbaboolvar                 = "vbaboolvar" nocase
        $api_pathfindnextcomponentw     = "pathfindnextcomponentw" nocase
        $api_rtlmovememory              = "rtlmovememory" nocase
        $api_vbavarzero                 = "vbavarzero" nocase
        $api_vbalsetfixstrfree          = "vbalsetfixstrfree" nocase
        $api_vbar8inti2                 = "vbar8inti2" nocase
        $api_sysfreestring              = "sysfreestring" nocase
        $api_sysallocstringlen          = "sysallocstringlen" nocase
        $api_sysallocstring             = "sysallocstring" nocase
        $api_sysstringlen               = "sysstringlen" nocase
        $api_sysallocstringbytelen      = "sysallocstringbytelen" nocase
        $api_pathremovefilespecw        = "pathremovefilespecw" nocase
        $api_pathisdirectoryw           = "pathisdirectoryw" nocase
        $api_virtualprotect             = "virtualprotect" nocase
        $api_virtualfree                = "virtualfree" nocase
        $api_createdirectoryw           = "createdirectoryw" nocase

        /* Imported DLLs */
        $dll_msvbvm60 = "msvbvm60.dll" nocase
        $dll_oleaut32 = "oleaut32.dll" nocase
        $dll_shlwapi  = "shlwapi.dll" nocase

    condition:
        /*
         Logic:
         1) Require detection of VB6 runtime DLLs (msvbvm60/oleaut32/shlwapi) AND
            at least two VB6 runtime helper symbols (rare outside VB6-built binaries).
         OR
         2) Match when 4 of the broader VB6/runtime API indicators appear (captures neighbor variants).
        */
        (
            $dll_msvbvm60 and $dll_oleaut32 and $dll_shlwapi and
            2 of (
                $api_vbavarmove, $api_vbafreevar, $api_vbafreevarlist, $api_vbafreeobjlist,
                $api_vbafreeobj, $api_vbafreestr, $api_vbafreestrlist, $api_vbafpexception,
                $api_sysreallocstring, $api_sysallocstring, $api_sysfreestring, $api_vbastrcat,
                $api_vbahresultcheckobj, $api_vbaobjset
            )
        )
        or
        (
            4 of (
                $api_cisqrt, $api_cisin, $api_cicos, $api_adjfptan, $api_adjfdivm64, $api_adjfdivm32,
                $api_adjfdivm16i, $api_adjfdivrm16i, $api_adjfdivrm64, $api_adjfdivm32i, $api_adjfdivrm32i,
                $api_adjfdivrm32, $api_adjfdivr, $api_adjfpatan, $api_adjfprem, $api_adjfprem1,
                $api_rtlmovememory, $api_vbavardup, $api_vbavarlatememcallld, $api_vbavarlatememcallldrf,
                $api_vbavarlatememcallst, $api_vbaarydestruct, $api_vbaarymove, $api_vbaaryunlock,
                $api_vbaarylock, $api_vbai4str, $api_vbai2i4, $api_vbai2str
            )
        )
}
