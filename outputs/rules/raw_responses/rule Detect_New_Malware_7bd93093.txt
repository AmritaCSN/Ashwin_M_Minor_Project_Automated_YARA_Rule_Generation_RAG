rule Detect_New_Malware_7bd93093
{
    meta:
        description = "Detects text-log based malware sample 7bd93093 and neighbors using specific API and DLL indicators."
        author = "malware-analyst"
        sha256 = "7bd930935f5318bf8b9b0905536d0183a43a58100ea9af549dfcbe79417f3cc1"
        created = "2023-10-27"

    strings:
        // Behavioral Indicators (APIs from new sample and neighbors)
        $api_dnshost = "dnshostnametocomputernamea"
        $api_winhttp = "winhttpclosehandle"
        $api_switchfiber = "switchtofiber"
        $api_mailslot = "getmailslotinfo"
        $api_console_proc_list = "getconsoleprocesslist"
        $api_actctx_sect = "findactctxsectionguid"
        $api_console_input = "peekconsoleinputw"
        $api_console_read = "readconsoleinputw"
        $api_console_aliases = "getconsolealiaseslengtha"
        $api_profile_sect = "getprofilesectiona"
        
        // Neighbor Shared/Unique API Indicators
        $api_copyfileex = "copyfileexw"
        $api_module32 = "module32nextw"
        $api_createsem = "createsemaphorew"
        $api_createnamedpipe = "createnamedpipew"
        $api_debugbreak = "debugbreak"
        $api_globalwire = "globalwire"
        $api_privprofile = "getprivateprofileintw"
        $api_cancelwait = "cancelwaitabletimer"
        
        // Imported DLLs
        $dll_winhttp = "winhttp.dll"

        // Benign Filter strings (to avoid) - Implicitly handled by selection of specific APIs above which are absent in benign context provided.
        // However, explicit exclusion of purely generic combos is good practice if rule matches broadly. 
        // Based on provided negative context, the above APIs are not present.

    condition:
        // Logic: 
        // 1. Must include the specific DLL "winhttp.dll" (found in target) OR strong unique API indicators.
        // 2. Must utilize a subset of the unique behavioral APIs found in the target/neighbors but NOT in benign files.
        
        (
            $dll_winhttp and 
            2 of ($api_dnshost, $api_switchfiber, $api_mailslot, $api_console_proc_list, $api_actctx_sect, $api_winhttp)
        )
        or
        (
            4 of ($api_console_input, $api_console_read, $api_console_aliases, $api_profile_sect, $api_copyfileex, $api_module32, $api_createsem, $api_createnamedpipe, $api_debugbreak, $api_globalwire, $api_privprofile, $api_cancelwait)
        )
}