# Automated YARA Rule Generation for Malware Detection using Retrieval-Augmented Generation (RAG)

This repository contains a framework and Jupyter Notebook to automate the creation of high-fidelity YARA rules for malware detection. It utilizes **Retrieval-Augmented Generation (RAG)** to produce *benign-aware* signatures and applies a **Greedy Set Cover** algorithm to optimize the final rule set.

---

## **Overview**

The framework processes malware textual metadata to generate detection rules through four main stages:

### **1. Knowledge Base Construction**
The system ingests a balanced dataset of malware and benign logs. It uses **Sentence-BERT** to create semantic embeddings, forming two vector indices:
- **Positive Index (Malware)**: For finding similar malware capabilities.
- **Negative Index (Benign)**: For identifying safe software patterns (Whitelisting).

### **2. Semantic Clustering (Efficiency Layer)**
To avoid redundant processing, the system uses **K-Means Clustering** (k=100) to group thousands of malware samples into distinct families.
- It calculates the **Geometric Centroid** of each cluster.
- It selects one **Representative Sample** per cluster to act as the blueprint for rule generation.

### **3. RAG-Driven Generation**
For each representative target, the system retrieves:
- **Positive Context**: "Sibling" malware from the same cluster to highlight shared behaviors.
- **Negative Context**: The nearest "Hard Negative" benign neighbors to explicitly avoid false positives.
This context is fed into a **Large Language Model (GPT-4o)** to generate syntax-valid YARA rules.

### **4. Greedy Optimization**
The generated rules undergo a Greedy Set Cover optimization.
This algorithm filters out redundant or weak rules, retaining only the minimal subset required to maximize detection coverage.
---

## **Dependencies**

All code is written in **Python 3**. The core logic is contained within a **Jupyter Notebook**.
The specific library dependencies are listed in `requirements.txt`.

### **Core Logic**
- `pandas`
- `numpy`
- `scikit-learn` (K-Means, Metrics)

### **AI / ML**
- `sentence-transformers` (SBERT Embeddings)
- `faiss-cpu` (Vector Database)
- `openai` (LLM Generation)

### **Visualization**
- `matplotlib`
- `seaborn`

### **Security**
- `yara-python` (Rule Compilation & Validation)

---

# **Description of Files**

## **Non-Python files**

| **File name**                       | **Description**                                                                                                       |
|-------------------------------------|------------------------------------------------------------------------------------------------------------------------|
| `README.md`                         | Text file (markdown format) containing the project description.                                                       |
| `requirements.txt`                  | List of Python dependencies required to run the notebook.                                                             |
| `Balanced_Malware_Dataset_500.csv`  | Input dataset containing malware and benign API logs and metadata. Sourced from https://figshare.com/articles/dataset/Windows_Malware_Detection_Dataset/21608262

## **Project Notebook**

| **File name**     | **Description** |
|--------------------|-----------------|
| `Project.ipynb`    | The main execution notebook. It handles data loading, embedding generation, clustering, LLM prompting (RAG), and final rule optimization. |




## **Output Directories (Generated during runtime)**

| **Directory name**                     | **Description** |
|----------------------------------------|-----------------|
| `outputs/rules/raw_responses/`         | Contains the raw text responses generated by the LLM before validation. |
| `outputs/rules/validated/`             | Contains the syntactically valid `.yar` files after passing the compiler check. |
| `outputs/final_optimization/`          | Stores the final `optimized_rule_sequence.csv` and the `saturation_curve.png` visualization. |



### **Setup**
1. **Clone the repository**
   ```bash
   git clone https://github.com/AmritaCSN/Ashwin_M_Minor_Project_Automated_YARA_Rule_Generation_RAG.git

2. **Install Dependencies**
   ```bash
   pip install -r requirements.txt
3. **Configure API Key**
   ```bash
   API_KEY = "sk-..."   # Or set via:  os.environ['OPENAI_API_KEY']
4. **Launch Jupyter Notebook**
    ```bash
    jupyter notebook Project.ipynb



## **Architecture Diagram**

![YARA Pipeline](diagram12.png)


